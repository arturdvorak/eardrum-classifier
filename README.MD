# Eardrum Classification with EfficientNetV2 + PyTorch Lightning

This project builds a robust classifier for tympanic membrane (eardrum) conditions using medical images. It leverages a pre-trained EfficientNetV2-S model from `timm`, fine-tunes it with PyTorch Lightning, and evaluates multiple transfer learning strategies.

---

## ðŸš€ Quick Start

### Installation

```bash
# Clone the repository
git clone <your-repo-url>
cd "Image Recognision"

# Install the package in development mode
pip install -e .
```

### Usage

#### 1. **Pipeline Script** (Recommended for full workflow)
```bash
# Run the complete pipeline
python scripts/run_pipeline.py --step all

# Run specific steps
python scripts/run_pipeline.py --step data      # Data setup only
python scripts/run_pipeline.py --step train     # Training only
python scripts/run_pipeline.py --step evaluate  # Evaluation only

# Get help
python scripts/run_pipeline.py --help
```

#### 2. **CLI Tools** (Individual operations)
```bash
# Training
eardrum-train

# Evaluation
eardrum-evaluate

# Prediction
eardrum-predict --image path/to/image.jpg --output predictions.json

# Get help for any tool
eardrum-train --help
eardrum-evaluate --help
eardrum-predict --help
```

#### 3. **Python Import**
```python
from eardrum_classifier import EfficientNetV2Lightning

# Create model
model = EfficientNetV2Lightning(
    num_classes=6,  # Aom, Chronic, Earwax, Normal, Otitis Externa, Tympanosclerosis
    lr=1e-4
)
```

---

## ðŸ“ Project Structure

```
Image Recognision/
â”œâ”€â”€ config/                 # Configuration files
â”œâ”€â”€ data/                   # Dataset directories
â”‚   â”œâ”€â”€ external/          # Raw downloaded data
â”‚   â”œâ”€â”€ processed/         # Processed and split data
â”‚   â””â”€â”€ raw/              # Original dataset
â”œâ”€â”€ docker/                # Docker configuration
â”œâ”€â”€ docs/                  # Documentation
â”œâ”€â”€ logs/                  # Training logs and MLflow tracking
â”œâ”€â”€ models/                # Saved models and checkpoints
â”œâ”€â”€ notebooks/             # Jupyter notebooks
â”œâ”€â”€ requirements/          # Dependencies
â”œâ”€â”€ scripts/               # Executable scripts
â”‚   â”œâ”€â”€ data_setup.py     # Data preparation
â”‚   â”œâ”€â”€ train.py          # Model training
â”‚   â”œâ”€â”€ evaluate.py        # Model evaluation
â”‚   â”œâ”€â”€ predict.py         # Inference
â”‚   â””â”€â”€ run_pipeline.py    # Complete pipeline
â”œâ”€â”€ src/                   # Source code package
â”‚   â””â”€â”€ eardrum_classifier/
â”‚       â”œâ”€â”€ data/          # Data loading and transforms
â”‚       â”œâ”€â”€ models/        # Model definitions
â”‚       â”œâ”€â”€ training/      # Training utilities
â”‚       â””â”€â”€ utils/         # Utility functions
â”œâ”€â”€ tests/                 # Test files
â”œâ”€â”€ web/                   # Web application
â””â”€â”€ setup.py              # Package configuration
```

---

## ðŸŽ¯ Features

### âœ… **Working Components**
- **CLI Tools**: `eardrum-train`, `eardrum-evaluate`, `eardrum-predict`
- **Pipeline Script**: Complete workflow orchestration
- **Python Package**: Importable `eardrum_classifier` module
- **Model Architecture**: EfficientNetV2 with PyTorch Lightning
- **Training Strategies**: Multiple fine-tuning approaches
- **MLflow Integration**: Experiment tracking and model management

### ðŸ”„ **Training Strategies**
- `freeze_backbone`: Only head is trainable
- `last1+head`, `last2+head`, `last3+head`, `last4+head`: Gradually unfreeze blocks
- `full`: All layers trainable

### ðŸ“Š **Evaluation Metrics**
- **Primary**: Macro F1 Score (robust to class imbalance)
- **Secondary**: Accuracy, Precision, Recall
- **Visualization**: Confusion matrices, performance plots

---

## Dataset

- **Source**: [Kaggle â€“ Eardrum Dataset (Otitis Media)](https://www.kaggle.com/datasets/erdalbasaran/eardrum-dataset-otitis-media)  
- **Total images**: 956  
- **Classes Used**:
  - Normal
  - Acute Otitis Media (AOM)
  - Chronic Otitis Media
  - Otitis Externa
  - Earwax
  - Tympanosclerosis
- **Excluded classes (due to very low samples)**:
  - Foreign
  - PseduoMembran
  - Earventulation

> **Cycle 2 classes only**:
> - Aom  
> - Chronic  
> - Earwax  
> - Normal

---

## ðŸ”§ Technical Details

### Model Architecture
- **Base Model**: EfficientNetV2-S from `timm`
- **Input Size**: 224Ã—224 pixels
- **Normalization**: ImageNet mean/std
- **Optimizer**: AdamW with ReduceLROnPlateau
- **Loss**: CrossEntropyLoss

### Data Pipeline
- **Augmentation**: Horizontal flip, rotation, normalization
- **Split Ratio**: 70% train / 15% validation / 15% test
- **Batch Size**: Configurable via configuration files

### Training Features
- **Early Stopping**: Prevents overfitting
- **Model Checkpointing**: Saves best models
- **Learning Rate Scheduling**: Adaptive LR adjustment
- **MLflow Tracking**: Experiment logging and comparison

---

## ðŸ“ˆ Usage Examples

### Training a Single Strategy
```bash
# Train with freeze_backbone strategy
eardrum-train

# Check training progress
tail -f logs/pipeline.log
```

### Evaluating Models
```bash
# Evaluate all trained strategies
eardrum-evaluate

# Results will be saved to logs/evaluation_results.json
```

### Making Predictions
```bash
# Single image prediction
eardrum-predict --image data/test/sample.jpg --output prediction.json

# Batch prediction
eardrum-predict --images data/test/*.jpg --output batch_predictions.json
```

### Running Complete Pipeline
```bash
# Run everything
python scripts/run_pipeline.py --step all --verbose

# Run with custom config
python scripts/run_pipeline.py --step all --config config/custom_config.yaml
```

---

## ðŸ“š Dependencies

### Core ML Libraries
- PyTorch â‰¥ 2.0
- PyTorch Lightning â‰¥ 2.0
- torchvision
- timm
- torchmetrics

### Data Processing
- scikit-learn
- pandas
- numpy
- matplotlib
- seaborn

### Experiment Tracking
- MLflow
- logging

### Development
- pytest
- black
- flake8
- mypy

---

*Last updated: August 2025*